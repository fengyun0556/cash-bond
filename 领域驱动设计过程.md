# 战略设计
## 业务领域
金融集团证券交易业务

## 子域划分
核心子域
- 投资组合管理域子域
- 投资咨询与建议子域
- 客户关系与财富规划子域
目前，核心子域都由业务部门自己操作。

支撑子域
- 合规与风控子域
- 订单管理与执行子域
- 指令采集子域：联系客户，建议执行交易，并获取用户授权。该子域没有对应系统。属于支撑子域。
  - 交易生命周期管理子域：Banker（可以认为是投资顾问）提交执行申请。属于支撑子域。
  - 交易审核子域：desk负责审核、向证券交易所发送交易指令。属于支撑子域。
  - 交易执行子域：通过与Bloomberg交互（这样可以降低成本，提高效率。高频交易不这样做，而是直接连接证券交易所），将交易指令发给各个证券交易所，并且获取执行结果。属于通用子域。
- 佣金费率子域
- 客户数据子域

通用子域
- 安全与身份认证子域
- 通知与通讯子域
- 结算子域：在证券公司内部属于通用子域：高度标准化、无差异化竞争力、规模效应（结算是一个高成本中心）。

重构 **交易生命周期管理子域** 与 **交易审核子域**


## 划分限界上下文
订单生命周期管理子域 --> 订单生命周期上下文：专注于内部流程的状态追踪。

交易审核子域 --> 交易审核上下文：对交易指令进行合规与风险审核，并决策是否执行。

交易执行网关子域 --> 交易执行上下文：作为与外部执行平台（Bloomberg）的网关，将审核通过的指令转化为标准订单并执行。


## 定义上下文映射关系
订单生命周期上下文 <--> 交易审核上下文：伙伴关系模式。两个上下文由同一个团队维护。

交易审核上下文 <--> 交易执行上下文：共享内核模式。交易执行上下文由多个团队共同维护，系统成型后，绝大多数情况下，每个团队只改属于本团队的部分。

交易执行上下文 <--> Bloomberg：遵奉者模式。Bloomberg是行业标准。

# 战术设计
## 领域建模
识别实体、值对象、聚合根，
定义领域服务、领域事件，
建立聚合边界

### 订单生命周期上下文
实体：
- Order（订单）
- CheckRuleRecord（规则记录）
- ExecutionRecord（已执行记录）

值对象：
- OrderState（订单状态）
- ExecuteState（执行状态）
- OrderType（订单类型）
- OrderRequestMode（订单申请模式）

聚合：

Order（聚合根）
- OrderId
- OrderState
- ExecuteState
- List<CheckRuleRecord>
- List<ExecutionRecord>

领域服务：
OrderLifecycleService
- orderCreated
- orderEnriched
- orderAmend
- orderApproved

OrderQueryService
- getOrderDetail(orderId)
- getOrders(criteria)

领域事件：
- OrderAmended（banker修改订单，再次触发交易结算）订阅方：交易审核上下文
- OrderEnriched（丰富电话订单后，继续交易结算）订阅方：交易审核上下文



### 交易审核上下文
实体：
- TradingInstruction（未执行的交易指令）
- ExecutedInstruction（已执行的交易指令）
- SettlementInteractionRecord（结算交互记录）

聚合：
- TradingInstruction（未执行的交易指令）
- ExecutedInstruction（已执行的交易指令）
- SettlementInteractionRecord（结算交互记录）

绝大多数情况下，未执行的交易指令 不直接与 已执行的交易指令 关联。交易审核上下文 中的三个实体的职责相对隔离，所以每个实体都是一个聚合。

领域服务：

TradingInstructionService
- addRemarks
- cancel
- update
- tradeAck
- autoRoute
- manualRoute

TradingInstructionQueryService
- getTradingInstructionDetail
- getTradingInstructionList

ExecutedInstructionService
- addRemarks
- cancel
- update
- confirm
- split
- correlatingLiveOrder

ExecutedInstructionQueryService
- getExecutedInstructionDetail
- getExecutedInstructionList

SettlementInteractionService
- triggerSettlement
- update
- sendToBanker（交由Banker处理）

SettlementInteractionQueryService
- getSettlementInteractionDetail
- getSettlementInteractionList

领域事件：

TradeExecutionRequested（发送交易指令）订阅方：交易执行上下文

TradingInstructionApproved（确认已执行的交易指令）订阅方：订单生命周期上下文 和 本上下文的交易结算模块

SettlementFailure（失败的交易结算）订阅方：订单生命周期管理上下文

### 交易执行上下文
领域事件：
- TradeAck（交易指令已收到）订阅方：订单生命周期上下文 和 交易审核上下文
- TradeExecuted（已执行交易指令）订阅方：交易审核上下文

## 架构设计
四层架构 + 六边形架构

[接口层]        - Controller, MQ Listener, Scheduled Task

[应用层]        - Application Services, DTO Assemblers

[领域层]        - Domain Models, Domain Services, Domain Events

[基础设施层]    - Repository实现, 外部服务Client, 消息发布
