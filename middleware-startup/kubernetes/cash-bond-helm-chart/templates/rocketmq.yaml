apiVersion: apps/v1
kind: Deployment
metadata:
  name: rocketmq-nameserver
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rocketmq-nameserver
  template:
    metadata:
      labels:
        app: rocketmq-nameserver
    spec:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
      - name: nameserver
        image: apache/rocketmq:{{ .Vaules.rocketmq.tag }}
        command: ["sh"]
        args: {{ .Vaules.rocketmq.nameserver.args }}
        ports:
        - containerPort: 9876
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-nameserver
  namespace: default
spec:
  selector:
    app: rocketmq-nameserver
  ports:
    - protocol: TCP
      port: 9876
      targetPort: 9876
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rocketmq-broker-config
  namespace: default
data:
  broker.conf: |
    brokerClusterName = DefaultCluster
    brokerName = broker-a
    brokerId = 0
    deleteWhen = 04
    fileReservedTime = 48
    brokerRole = ASYNC_MASTER
    flushDiskType = ASYNC_FLUSH
    # 关键配置：通过K8S Service名连接NameServer
    namesrvAddr = rocketmq-nameserver:9876
    # 允许自动创建Topic，方便测试
    autoCreateTopicEnable = true
    # Broker对外暴露的地址配置，让客户端能够连接
    # 这里设置为K8S Service名
    brokerIP1 = rocketmq-broker
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rocketmq-broker
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rocketmq-broker
  template:
    metadata:
      labels:
        app: rocketmq-broker
    spec:
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      # 需要与NameServer通信，所以需要在一个命名空间
      containers:
      - name: broker
        image: apache/rocketmq:{{ .Vaules.rocketmq.tag }}
        command: ["sh"]
        args: {{ .Values.rocketmq.broker.args }}
        ports:
        - containerPort: 10909
        - containerPort: 10911
        - containerPort: 10912
        env:
        - name: JAVA_OPT
          value: "-Duser.home=/home/rocketmq -Xms4g -Xmx4g -Xmn2g"
        resources:
          requests:
            memory: "6Gi"
            cpu: "1000m"
          limits:
            memory: "8Gi"
            cpu: "2000m"
        volumeMounts:
        - name: broker-storage
          mountPath: /home/rocketmq/store
        - name: config-volume
          mountPath: {{ .Values.rocketmq.volumeMounts.config.mountPath }}
          subPath: broker.conf
      volumes:
      - name: broker-storage
        emptyDir: {} # 使用临时存储，学习测试用
      - name: config-volume
        configMap:
          name: rocketmq-broker-config
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq-broker
  namespace: default
spec:
  selector:
    app: rocketmq-broker
  ports:
    - name: broker-1
      protocol: TCP
      port: 10909
      targetPort: 10909
    - name: broker-2
      protocol: TCP
      port: 10911
      targetPort: 10911
    - name: broker-3
      protocol: TCP
      port: 10912
      targetPort: 10912
